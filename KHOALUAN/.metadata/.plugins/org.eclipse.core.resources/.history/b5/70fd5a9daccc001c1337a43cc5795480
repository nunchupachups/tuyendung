package cntt.trang.controller;

import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import cntt.trang.bean.TimKiemSV;
import cntt.trang.bean.TuyenDung;
import cntt.trang.dao.DoanhNghiepDAO;
import cntt.trang.dao.HinhThucLamViecDAO;
import cntt.trang.dao.NganhNgheDAO;
import cntt.trang.dao.SinhVienDAO;
import cntt.trang.dao.TinhThanhDAO;
import cntt.trang.dao.TuyenDungDAO;
import cntt.trang.dao.VNCharacterUtils;

@Controller
@RequestMapping(value = "/tuyendung")
public class TuyenDungController {
	@RequestMapping(value= {"","/timkiem"}, method=RequestMethod.GET)
    public String tuyenDung(Model model,HttpSession session,HttpServletRequest  request,HttpServletResponse response) {
	 	try {
	 		response.setContentType("text/html;charset=UTF-8");
	 		request.setCharacterEncoding("UTF-8");
	 		TuyenDungDAO tuyenDungDAO=new TuyenDungDAO();
	 		NganhNgheDAO nganhNgheDAO=new NganhNgheDAO();
	 		HinhThucLamViecDAO hinhThucLamViecDAO=new HinhThucLamViecDAO();
	 		TinhThanhDAO tinhThanhDAO= new TinhThanhDAO();
	 		DoanhNghiepDAO doanhNghiepDAO=new DoanhNghiepDAO();
	 		
	 		
	 		model.addAttribute("dsNganhNghe", nganhNgheDAO.getAllNganhNghe());
	 		model.addAttribute("dsHinhThuc",hinhThucLamViecDAO.getAllHinhThucLamViec());
	 		model.addAttribute("dsTinhThanh", tinhThanhDAO.getAllTinhThanh());
	 		model.addAttribute("nganhNgheDAO", nganhNgheDAO);
	 		model.addAttribute("hinhThucLamViecDAO", hinhThucLamViecDAO);
	 		model.addAttribute("doanhNghiepDAO", doanhNghiepDAO);
	 		model.addAttribute("tinhThanhDAO", tinhThanhDAO);
	 		model.addAttribute("tuyenDungs",tuyenDungDAO.timKiemTuyenDung(1, "", -1, -1, "-1"));
	 		model.addAttribute("soPage",tuyenDungDAO.getSoPage("", -1, -1, "-1"));
	 		model.addAttribute("title", "Tuyển dụng");
	    	return "tuyendung/timkiemtuyendung";
		} catch (Exception e) {
			e.getStackTrace();
			return null;
		}
       
    }
	@RequestMapping(value= {"/timkiem"}, method=RequestMethod.POST)
    public void timKiemTuyenDung(Model model,HttpSession session,HttpServletRequest  request,HttpServletResponse response) {
	 	try {
	 		response.setContentType("text/html;charset=UTF-8");
	 		request.setCharacterEncoding("UTF-8");
	 		
	 		String key= request.getParameter("key");
	 		String maNganhNghe= request.getParameter("maNganhNghe");
	 		String maHinhThuc= request.getParameter("maHinhThuc");
	 		String maKhuVuc= request.getParameter("maKhuVuc");
	 		
	 		TinhThanhDAO tinhThanhDAO= new TinhThanhDAO();
	 		
	 		TuyenDungDAO tuyenDungDAO= new TuyenDungDAO();
	 		NganhNgheDAO nganhNgheDAO= new NganhNgheDAO();
	 		HinhThucLamViecDAO hinhThucLamViecDAO= new HinhThucLamViecDAO();
	 		
	 		int soPage = tuyenDungDAO.getSoPage("", -1, -1, "-1");
	 		
	 		ArrayList<TuyenDung> tuyenDungs;
	 		Set<TuyenDung> ds=new HashSet<TuyenDung>();
	 		if(!key.equals("")) {
	 			String keys[] =key.split(" ");
	 			for(int i=0; i< keys.length;i++) {
	 				ds.addAll(tuyenDungDAO.timKiemTuyenDung(1,VNCharacterUtils.removeAccent(keys[i]) ,Long.parseLong(maNganhNghe), Long.parseLong(maHinhThuc), maKhuVuc));
	 			}
	 			tuyenDungs=new ArrayList<TuyenDung>();
	 			for (TuyenDung td : ds) {
	 				tuyenDungs.add(td);
				}
	 		}
	 		else tuyenDungs=tuyenDungDAO.timKiemTuyenDung(1,VNCharacterUtils.removeAccent(key) ,Long.parseLong(maNganhNghe), Long.parseLong(maHinhThuc), maKhuVuc);
	 		
	 		
	 		PrintWriter out=response.getWriter();
	 		if(tuyenDungs.isEmpty()) 
	 			out.print("<h4 style=\"color: #c0c0c0;\">Không tìm thấy công việc nào phù hợp với yêu cầu tìm kiếm của bạn</h4>");
	 		else
	 			for (TuyenDung td : tuyenDungs) {
					out.print("<div class=\"tuyendung\" style=\"position: relative;\">\r\n" + 
							"		        <div class=\"tuyendung-container\">\r\n" + 
							"		            <h3>"+td.getTieuDe() +"</h3>\r\n" + 
							"		            <b><i>Ngành nghề: </i></b>"+nganhNgheDAO.getNganhNgheByID(td.getMaNganhNghe()).getTenNganhNghe() +"<br>\r\n" + 
							"		            <b><i>Tên công việc: </i></b>"+td.getTenCongViec() +" <br>\r\n" + 
							"		            <b><i>Hình thức làm việc: </i></b>"+hinhThucLamViecDAO.getHinhThucLamViecByID(td.getMaHinhThuc()).getTenHinhThuc() +"<br>\r\n");
							if(td.getThoiGianThuViec()!=null) out.print("<b><i>Thời gian thử việc: </i></b>"+td.getThoiGianThuViec() +"<br>");
							if(td.getSinhVienNam()!=0) out.print("<b><i>Sinh viên năm: </i></b>"+td.getSinhVienNam() +"<br>");
							if(td.getGioiTinh()!=null) out.print("<b><i>Giới tính: </i></b>"+td.getGioiTinh() +"<br>");
					if(td.getKhuVucTuyenDung().equals("00")) 
						out.print("<b><i>Khu vực tuyển: </i></b>Cả nước<br>\r\n");
					else out.print("<b><i>Khu vực tuyển: </i></b>"+tinhThanhDAO.getTinhThanhById(td.getKhuVucTuyenDung()).getTenTinhThanh()  +"<br>" );
							out.print(
							"		            <b><i>Số lượng: </i></b>"+td.getSoLuong() +"<br>\r\n" + 
							"		            <b><i>Mức lương: </i></b>"+td.getMucLuong() +"<br>\r\n" + 
							"		            <b><i>Hạn đăng ký: </i></b>"+td.getHanDangKy() +"<br>\r\n" + 
							"		            <b><i>MÔ TẢ CÔNG VIỆC</i></b> <br>\r\n" + td.getMoTaCongViec() + 
							"		            <b><i>YÊU CẦU CÔNG VIỆC</i></b><br>\r\n" + td.getYeuCauCongViec() + 
							"		            <b><i>QUYỀN LỢI</i></b><br>\r\n" + td.getQuyenLoi() + 
							"		        </div>\r\n" + 
							"		        <div style=\"position: absolute;bottom: 15px;right: 50px;\">\r\n" + 
							"		        	<c:if test=\""+td.isDaDuyet()+"\">\r\n" + 
							"		            	<button class=\"btn btn-danger\">Chưa được duyệt</button>\r\n" + 
							"		        	</c:if>\r\n" + 
							"		        </div>\r\n" + 
							"		    </div>");
				}
		} catch (Exception e) {
			e.printStackTrace();
			
		}
       
    }
}
