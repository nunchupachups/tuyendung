package cntt.trang.controller;

import org.springframework.web.bind.annotation.RequestMapping;

@Controller
@RequestMapping(value = "/dangnhap")
public class DangNhapController {
	@RequestMapping("/dangnhap")
	public ModelAndView kiemtradn(Model model, HttpSession session, HttpServletRequest request, HttpServletResponse response) {
	       try {
	    	   boolean valid=false;
	    	   request.setCharacterEncoding("UTF-8");
	    	   response.setCharacterEncoding("UTF-8");
	    	   response.setContentType("text/html; charset=utf-8");
	    	   taikhoanbo tkbo = new taikhoanbo();
	    	   
	    	   String tendangnhap = request.getParameter("txtun");
	    	   String matkhau = request.getParameter("txtpwd");
	    	   String gRecaptchaResponse = request.getParameter("g-recaptcha-response");
	    	   valid = VerifyUtils.verify(gRecaptchaResponse);
	    	   
	    	   taikhoanbean tk=tkbo.kiemtradn(tendangnhap, matkhau);
	    	   if (tk!=null && valid) {
	    		   session.setAttribute("user", tkbo.kiemtradn(tendangnhap, matkhau)); 
	    		   if (tk.isQuyen()) return new ModelAndView("redirect:/qldonchuaduyet");
	    	   }else {
	    		   if(!valid) model.addAttribute("tb", "rcs"); 
	    		   else model.addAttribute("tb", "dns"); 
	    		   
	    	   }
	    	   
	    	   return new ModelAndView("redirect:/trangchu");
	       }catch (Exception e) {
	    	   e.printStackTrace();return null;
	       }
	    }
}
